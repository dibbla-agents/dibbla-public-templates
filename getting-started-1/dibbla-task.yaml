version: "1"

env:
  ENV_HELLO_NAME:
    description: "Name used by the /api/hello endpoint greeting"
    default: "Dibbla"

tools:
  brew:
    check: "brew --version"
    privileged: true
    install:
      darwin: 'NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
  git:
    check: "git --version"
    install:
      darwin: "brew install git"
  node:
    check: "node --version"
    install:
      darwin: "brew install node"
  go:
    check: "go version"
    install:
      darwin: "brew install go"
  docker:
    check: "docker --version"
    install:
      darwin: "brew install --cask docker"

steps:
  # ── Tool verification ──────────────────────────────────────────────
  - id: verify-brew
    name: "Verify Homebrew"
    type: tool_check
    tool: brew

  - id: verify-git
    name: "Verify Git"
    type: tool_check
    tool: git
    depends_on: ["verify-brew"]

  - id: verify-node
    name: "Verify Node.js"
    type: tool_check
    tool: node
    depends_on: ["verify-brew"]

  - id: verify-go
    name: "Verify Go"
    type: tool_check
    tool: go
    depends_on: ["verify-brew"]

  - id: verify-docker
    name: "Verify Docker"
    type: tool_check
    tool: docker
    depends_on: ["verify-brew"]

  # ── Environment setup ──────────────────────────────────────────────
  - id: write-env
    name: "Write .env File"
    type: write_env

  # ── Frontend build ─────────────────────────────────────────────────
  - id: install-frontend-deps
    name: "Install Frontend Dependencies"
    type: command
    run: "npm ci"
    working_dir: "./frontend"
    depends_on: ["verify-node"]

  - id: build-frontend
    name: "Build Frontend"
    type: command
    run: "npm run build"
    working_dir: "./frontend"
    depends_on: ["install-frontend-deps"]

  # ── Go build ───────────────────────────────────────────────────────
  - id: go-mod-download
    name: "Download Go Modules"
    type: command
    run: "go mod download"
    depends_on: ["verify-go"]

  - id: build-go
    name: "Build Go Binary"
    type: command
    run: "CGO_ENABLED=0 go build -o ./bin/server main.go"
    env:
      CGO_ENABLED: "0"
    depends_on: ["build-frontend", "go-mod-download", "write-env"]

  # ── Docker ─────────────────────────────────────────────────────────
  - id: docker-build
    name: "Build Docker Image"
    type: command
    run: "docker build -t getting-started-1 ."
    depends_on: ["verify-docker", "build-go"]

  # ── Dev servers ───────────────────────────────────────────────────
  - id: kill-port-8080
    name: "Kill Process on Port 8080"
    type: command
    run: "lsof -ti:8080 | xargs kill -9 2>/dev/null || true"
    depends_on: ["build-go"]

  - id: run-backend
    name: "Start Go Backend"
    type: command
    mode: background
    run: "PORT=8080 ./bin/server"
    depends_on: ["kill-port-8080"]

  - id: kill-port-5173
    name: "Kill Process on Port 5173"
    type: command
    run: "lsof -ti:5173 | xargs kill -9 2>/dev/null || true"
    depends_on: ["install-frontend-deps", "run-backend"]

  - id: start-frontend-dev
    name: "Start Vite Dev Server"
    type: command
    mode: terminal
    run: "npm run dev"
    working_dir: "./frontend"
    depends_on: ["kill-port-5173"]